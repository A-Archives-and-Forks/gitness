version: "2"
linters:
  default: none
  enable:
    - asasalint
    - asciicheck
    - bidichk
    - bodyclose
    - contextcheck
    - copyloopvar
    - durationcheck
    - errcheck
    - errname
    - errorlint
    - exhaustive
    - forbidigo
    - goconst
    - gocritic
    - godot
    - goheader
    - gomoddirectives
    - gomodguard
    - goprintffuncname
    - gosec
    - govet
    - ineffassign
    - lll
    - makezero
    - misspell
    - nakedret
    - nestif
    - nilerr
    - nilnil
    - noctx
    - nosprintfhostport
    - predeclared
    - promlinter
    - reassign
    - revive
    - rowserrcheck
    - sqlclosecheck
    - staticcheck
    - tagliatelle
    - tparallel
    - unconvert
    - unparam
    - unused
    - usestdlibvars
    - wastedassign
    - whitespace
  settings:
    revive:
      rules:
        - name: var-naming
          severity: warning
          disabled: true
    errcheck:
      check-type-assertions: true
    gocritic:
      settings:
        captLocal:
          paramsOnly: false
        underef:
          skipRecvDeref: false
    goheader:
      template: |-
        Copyright 2023 Harness, Inc.

        Licensed under the Apache License, Version 2.0 (the "License");
        you may not use this file except in compliance with the License.
        You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

        Unless required by applicable law or agreed to in writing, software
        distributed under the License is distributed on an "AS IS" BASIS,
        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        See the License for the specific language governing permissions and
        limitations under the License.
    gomodguard:
      blocked:
        modules:
          - github.com/golang/protobuf:
              recommendations:
                - google.golang.org/protobuf
              reason: see https://developers.google.com/protocol-buffers/docs/reference/go/faq#modules
          - github.com/satori/go.uuid:
              recommendations:
                - github.com/google/uuid
              reason: satori's package is not maintained
          - github.com/gofrs/uuid:
              recommendations:
                - github.com/google/uuid
              reason: 'see recommendation from dev-infra team: https://confluence.gtforge.com/x/gQI6Aw'
    govet:
      disable:
        - fieldalignment
      enable-all: true
      settings:
        shadow:
          strict: true
    nakedret:
      max-func-lines: 30
    rowserrcheck:
      packages:
        - github.com/jmoiron/sqlx
    staticcheck:
      checks:
        - all
        - -SA1019
        - -QF1008
    tagliatelle:
      case:
        rules:
          avro: snake
          bson: snake
          db: snake
          json: snake
          mapstructure: snake
          xml: snake
          yaml: snake
  exclusions:
    generated: lax
    presets:
      - comments
      - common-false-positives
      - legacy
      - std-error-handling
    rules:
      - linters:
          - govet
        text: 'shadow: declaration of "(err|ctx|ok)" shadows declaration at'
      - linters:
          - lll
        source: ^//\s*go:generate\s
      - linters:
          - gomoddirectives
        text: 'local replacement are not allowed: github.com/harness/gitness'
      - linters:
          - gomoddirectives
        text: 'replacement are not allowed: github.com/docker/docker'
      - linters:
          - godot
        source: (noinspection|TODO)
      - linters:
          - gocritic
        source: //noinspection
      - linters:
          - errorlint
        source: ^\s+if _, ok := err\.\([^.]+\.InternalError\); ok {
      - linters:
          - forbidigo
        path: ^cli/
      - linters:
          - revive
          - staticcheck
          - tagliatelle
        path: ^registry/app/manifest/.*
      - linters:
          - errorlint
        path: ^registry/app/dist_temp/.*
      - linters:
          - gocritic
        path: ^registry/app/driver/filesystem/.*
      - linters:
          - gocognit
          - gosec
          - nestif
        path: ^registry/app/driver/s3-aws/.*
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/interceptor/interceptor.go
      - linters:
          - goheader
        path: ^registry/app/common/http/modifier/modifier.go
      - linters:
          - goheader
        path: ^registry/app/driver/fileinfo.go
      - linters:
          - goheader
        path: ^registry/app/driver/storagedriver.go
      - linters:
          - goheader
        path: ^registry/app/driver/walk.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/challenge/addr.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/challenge/authchallenge.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/challenge/authchallenge_test.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/requestutil/util.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/requestutil/util_test.go
      - linters:
          - goheader
        path: ^registry/app/pkg/commons/zipreader/*
      - linters:
          - goheader
        path: ^registry/app/manifest/descriptor.go
      - linters:
          - goheader
        path: ^registry/app/manifest/doc.go
      - linters:
          - goheader
        path: ^registry/app/manifest/errors.go
      - linters:
          - goheader
        path: ^registry/app/manifest/manifests.go
      - linters:
          - goheader
        path: ^registry/app/manifest/versioned.go
      - linters:
          - goheader
        path: ^registry/app/common/lib/authorizer.go
      - linters:
          - goheader
        path: ^registry/app/common/lib/link.go
      - linters:
          - goheader
        path: ^registry/app/common/http/tls.go
      - linters:
          - goheader
        path: ^registry/app/common/http/transport.go
      - linters:
          - goheader
        path: ^registry/app/common/http/transport_test.go
      - linters:
          - goheader
        path: ^registry/app/manifest/schema2/manifest.go
      - linters:
          - goheader
        path: ^registry/app/manifest/schema2/manifest_test.go
      - linters:
          - goheader
        path: ^registry/app/manifest/ocischema/index.go
      - linters:
          - goheader
        path: ^registry/app/manifest/ocischema/manifest.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/auth/null/authorizer.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/auth/basic/authorizer.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/auth/basic/authorizer_test.go
      - linters:
          - goheader
        path: ^registry/app/common/lib/errors/const.go
      - linters:
          - goheader
        path: ^registry/app/common/lib/errors/errors.go
      - linters:
          - goheader
        path: ^registry/app/common/lib/errors/stack.go
      - linters:
          - goheader
        path: ^registry/app/common/lib/errors/stack_test.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/auth/bearer/authorizer.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/auth/bearer/cache.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/auth/bearer/scope.go
      - linters:
          - goheader
        path: ^registry/app/manifest/manifestlist/manifestlist.go
      - linters:
          - goheader
        path: ^registry/app/manifest/manifestlist/manifestlist_test.go
      - linters:
          - goheader
        path: ^registry/app/driver/factory/factory.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/context.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/doc.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/http.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/logger.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/trace.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/util.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/version.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/http_test.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/trace_test.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/dcontext/version_test.go
      - linters:
          - goheader
        path: ^registry/app/driver/base/base.go
      - linters:
          - goheader
        path: ^registry/app/driver/base/regulator.go
      - linters:
          - goheader
        path: ^registry/app/driver/base/regulator_test.go
      - linters:
          - goheader
        path: ^registry/app/storage/blobs.go
      - linters:
          - goheader
        path: ^registry/app/storage/blobwriter.go
      - linters:
          - goheader
        path: ^registry/app/storage/blobwriter_resumable.go
      - linters:
          - goheader
        path: ^registry/app/storage/errors.go
      - linters:
          - goheader
        path: ^registry/app/storage/filereader.go
      - linters:
          - goheader
        path: ^registry/app/storage/gcstoragelient.go
      - linters:
          - goheader
        path: ^registry/app/storage/io.go
      - linters:
          - goheader
        path: ^registry/app/storage/middleware.go
      - linters:
          - goheader
        path: ^registry/app/storage/ociblobstore.go
      - linters:
          - goheader
        path: ^registry/app/storage/paths.go
      - linters:
          - goheader
        path: ^registry/app/storage/storageservice.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/client.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/adapter.go
      - linters:
          - goheader
        path: ^registry/app/remote/clients/registry/auth/authorizer.go
      - linters:
          - goheader
        path: ^registry/app/driver/s3-aws/s3.go
      - linters:
          - goheader
        path: ^registry/app/driver/s3-aws/s3_v2_signer.go
      - linters:
          - goheader
        path: ^registry/app/driver/filesystem/driver.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/app.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/catalog.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/compat.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/context.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/controller.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/local.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/manifest_service.go
      - linters:
          - goheader
        path: ^registry/app/pkg/docker/remote.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/dockerhub/adapter.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/awsecr/adapter.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/maven/adapter.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/awsecr/auth.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/dockerhub/client.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/dockerhub/consts.go
      - linters:
          - goheader
        path: ^registry/app/driver/testsuites/testsuites.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/errcode/errors.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/errcode/handler.go
      - linters:
          - goheader
        path: ^registry/app/dist_temp/errcode/register.go
      - linters:
          - goheader
        path: ^registry/app/remote/controller/proxy/controller.go
      - linters:
          - goheader
        path: ^registry/app/remote/controller/proxy/inflight.go
      - linters:
          - goheader
        path: ^registry/app/remote/controller/proxy/local.go
      - linters:
          - goheader
        path: ^registry/app/remote/controller/proxy/remote.go
      - linters:
          - goheader
        path: ^registry/app/remote/controller/proxy/inflight_test.go
      - linters:
          - goheader
        path: ^registry/app/remote/adapter/native/adapter.go
      - linters:
          - gosec
        path: ^registry/app/storage/blobStore.go
      - linters:
          - lll
          - tagliatelle
        path: ^registry/app/metadata/nuget/metadata.go
      - linters:
          - errcheck
          - gocritic
          - godot
          - goheader
          - lll
        path: ^registry/app/api/controller/mocks/
    paths:
      - third_party$
      - builtin$
      - examples$

issues:
  max-same-issues: 10
formatters:
  enable:
    - gci
    - goimports
  settings:
    gci:
      sections:
        - standard
        - prefix(github.com/harness/gitness)
        - default
        - blank
        - dot
      custom-order: true
  exclusions:
    generated: lax
    paths:
      - third_party$
      - builtin$
      - examples$
